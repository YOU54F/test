name: test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  STABLE_PYTHON_VERSION: "3.11"
  PYTEST_ADDOPTS: --color=yes

jobs:
  test:
    name: Example

    runs-on: ubuntu-latest
    services:
      broker:
        image: pactfoundation/pact-broker:latest
        ports:
          - "9292:9292"
        env:
          # Basic auth credentials for the Broker
          PACT_BROKER_ALLOW_PUBLIC_READ: "true"
          PACT_BROKER_BASIC_AUTH_USERNAME: pactbroker
          PACT_BROKER_BASIC_AUTH_PASSWORD: pactbroker
          # Database
          PACT_BROKER_DATABASE_URL: sqlite:////tmp/pact_broker.sqlite
        options: >-
          --health-cmd "curl -sSf http://pactbroker:pactbroker@localhost:9292/diagnostic/status/heartbeat"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Check broker is live
        run: |
          curl -sSf http://pactbroker:pactbroker@localhost:9292/diagnostic/status/heartbeat